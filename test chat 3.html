<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi-Problem Python Grader</title>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython_stdlib.js"></script>
  <style>
    textarea, select, pre {
      width: 100%;
      font-family: monospace;
      margin-top: 10px;
    }
    button {
      margin-top: 10px;
    }
    .result {
      background: #f2f2f2;
      padding: 10px;
      margin-top: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body onload="brython()">
  <h1>Python Grader (Multiple Problems)</h1>

  <label for="problem">Select Problem:</label><br>
  <select id="problem">
    <option value="sum_two_numbers">1. Sum of Two Numbers</option>
    <option value="max_of_three">2. VAT7</option>
  </select>

  <label for="code">Student Code:</label><br>
  <textarea id="code" rows="6">
  </textarea><br>

  <button onclick="runCode()">Run & Evaluate</button>

  <button onclick="downloadCSV()">üì• Download CSV</button>

  <div class="result" id="output">Output will appear here...</div>

  <script type="text/python">
from browser import document, html, window
import traceback
import sys
from io import StringIO
import re

test_banks = {
    "sum_two_numbers": {
        "name": "Sum of Two Numbers",
        "cases": [
            {"input": [3, 5], "output": "8"},
            {"input": [10, 15], "output": "25"}
        ]
    },
    "max_of_three": {
        "name": "Max of Three Numbers",
        "cases": [
            {"input": ["550"], "output": "588.5"},
            {"input": ["100"], "output": "107.0"}
        ]
    }
}

def replace_inputs(code, inputs):
    # ‡πÅ‡∏ó‡∏ô input() ‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å test case
    def repl(match):
        val = inputs.pop(0)
        return f"'{val}'" if isinstance(val, str) else str(val)
    
    # ‡πÉ‡∏ä‡πâ regex ‡∏´‡∏≤ input() ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô
    pattern = r"input\s*\(\s*\)"
    return re.sub(pattern, repl, code)

def runCode():
    selected = document["problem"].value
    test_cases = test_banks[selected]["cases"]
    original_code = document["code"].value


    output_div = document["output"]
    output_text = f"Selected Problem: {test_banks[selected]['name']}\n\n"

    for test in test_cases:
        input_data = test["input"].copy()
        expected = test["output"]
        final_code = replace_inputs(original_code, input_data)

        output_io = StringIO()
        sys_stdout_backup = sys.stdout
        sys.stdout = output_io

        try:
            exec(final_code, {"__name__": "__main__"})
            student_output = output_io.getvalue().strip()
        except Exception:
            student_output = f"Error: {traceback.format_exc(limit=1)}"
        finally:
            sys.stdout = sys_stdout_backup

        correct = student_output == expected

        # ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô results_data
        results_data.append({
            "problem": test_banks[selected]["name"],
            "input": test["input"],
            "expected": expected,
            "student_output": student_output,
            "correct": correct
        })

        # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ñ‡∏™
        output_text += f"{'‚úÖ Correct' if correct else '‚ùå Incorrect'}\n\n"

    output_div.text = output_text

window.runCode = runCode
results_data = []  # ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£

def runCode():
    ...

    for test in test_cases:
        ...
        result = {
            "problem": test_banks[selected]["name"],
            "input": test["input"],
            "expected": expected,
            "student_output": student_output,
            "correct": student_output == expected
        }
        results.append(result)
        results_data.append(result)  # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö export CSV

    ...

def downloadCSV():
    if not results_data:
        window.alert("‚õî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô")
        return

    csv = "Problem,Input,Expected,Student Output,Result\n"
    for r in results_data:
        line = f"{r['problem']}," \
               f"{'|'.join(map(str, r['input']))}," \
               f"{r['expected']}," \
               f"{r['student_output']}," \
               f"{'Correct' if r['correct'] else 'Incorrect'}"
        csv += line + "\n"

    blob = window.Blob.new([csv], { "type": "text/csv" })
    url = window.URL.createObjectURL(blob)
    link = document.createElement("a")
    link.href = url
    link.download = "grading_results.csv"
    document <= link
    link.click()
    link.remove()

window.downloadCSV = downloadCSV

def on_problem_change(event):
    document["code"].value = ""  # ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á student code

document["problem"].bind("change", on_problem_change)


  </script>
</body>
</html>
